\label{sec:preliminaries-ppn}

By reduction from the halting problem as well as the counter boundedness problem, \cite{David17} has shown that \Ucov and \Ecov are undecidable on \ac{PPN}.
This motivates the introduction of natural subclasses of \acp{PPN} where parametric coverability problems are decidable.

Namely,
PreT-PPNs are \acp{PPN} where parameters are used only in $\matI$,
PostT-PPNs are \acp{PPN} where parameters are used only in $\matO$,
and P-PPNs are \ac{PPN} where parameters are used only in the initial marking $\mari$.
\todo{Re-write the following paragraph.}
These subclasses were extensively studied in \cite{David17} where is given
an adaptation of the Karp and Miller Algorithm to solve the \Ucov problem on PreT-\acp{PPN}, and another to solve the \Ecov problem on PostT-\acp{PPN}, as well as the complexity of these problems.
We will present this two algorithms as they contain ideas used in the sequel.
\todo{Introduce next subsection}

\subsection{Links between P-PPNs and PostT-PPNs}

Considering the synthesis of valuations for P-PPNs, one idea that comes naturally is to apply $\back$ from a marking to be covered.
We also have the intuition that this same result can be obtained in a similar way for PostT-PPNs. 
This leads us to look for links between these two models.

\subsubsection{From PostT-PPNs to P-PPNs}

We will show how to construct a P-PPN that simulates a given PostT-PPN, that is, one that have the same behaviour.

\begin{defi}[Simulation on Petri nets]
  Given two \acp{PPN}, \SPTPmi and \SPTPmii, a relation $\rela \in (\mathbb{N} \cup  \mathbb{P}_1)^{|P_1|} \times (\mathbb{N} \cup  \mathbb{P}_2)^{|P_2|}$ is a \emph{simulation} if
  \[
    \forall (\mar_1, \mar_2) \in \rela \Leftrightarrow
    \begin{cases}
      \forall t_1 \in T_1, \marp_1 \text{ such that } \mar_1 \fire{t_1} \marp_1 \\
      \exists t_2 \in T_2, \marp_2 \text{ such that } \mar_2 \fire{t_2} \marp_2
        \text{ and } (\marp_1, \marp_2) \in \rela.
    \end{cases}
  \]
  If there exists such a relation $\rela$ with $(\mar_{0,1}, \mar_{0,2}) \in \rela$, we say that \PPNii \emph{simulates} \PPNi.
\end{defi}

Actually, we will divide the set of transitions of our new P-PPN into two separate subsets: usual or observable transitions, and silent transitions.
The latter form a machinery that is not taken into account for the result of the simulation, then called a ``weak simulation'':
\begin{defi}[Weak simulation on Petri nets]
  Given two \acp{PPN}, \SPTPmi and \SPTPmii,
  where $T_1 = T_{u1} \cup T_{s1}, T_{u1} \cap T_{s1} = \emptyset$,
  and   $T_2 = T_{u2} \cup T_{s2}, T_{u2} \cap T_{s2} = \emptyset$,
  a relation $\rela \in (\mathbb{N} \cup  \mathbb{P}_1)^{|P_1|} \times (\mathbb{N} \cup  \mathbb{P}_2)^{|P_2|}$ is a \emph{weak simulation} if
  \[
    \forall (\mar_1, \mar_2) \in \rela \Leftrightarrow
    \left\{
    \begin{aligned}
      &\forall t_1 \in T_1, \marp_1 \text{ such that } \mar_1 \fire{\sigma_1} \marp_1 \\
      &\exists t_2 \in T_2, \marp_2 \text{ such that } \mar_2 \fire{\sigma_2} \marp_2
        \text{ and } (\marp_1, \marp_2) \in \rela,
    \end{aligned}
    \right.
  \]
where $\sigma_i$ is a sequence of zero or more transition from $T_{si}$ followed by a transition of $T_{ui}$ followed by zero or more transition of $T_{si}$.\todo{introduce regular notation}

  If there exists such a relation $\rela$ with $(\mar_{0,1}, \mar_{0,2}) \in \rela$, we say that \PPNii \emph{weakly simulates} \PPNi.
\end{defi}

\begin{figure}[htbp]
  \centering
  \include{res/widget}
  \par
  \caption{From PostT-PPN to P-PPN}
  \label{fig:posttppn-to-pppn}
\end{figure}

\todo{We will see later that to establish that there is a simulation between two networks makes it possible to deduce many results.}

We can now construct for any PostT-PPN a P-PPN that simulates it.

Given a PostT-PPN $\PPN_1 = \langle P_1, T_1, \mathbb{P}, \mar_{0,1} \rangle$, create the new P-PPN $\PPN_2 = \langle P_2, T_2, \mathbb{P}, \mar_{0,2} \rangle$ like this.
Starting with an identical \ac{PPN}, first add a new place labelled \texttt{lock}, and, to all the transitions that does not have a parametrised output arc, add an input arc from, and an output one to \texttt{lock}.
Then, for all parametrised transition $t$, replace the parametrised output arcs by the silent subnet depicted in blue on figure~\ref{fig:posttppn-to-pppn}:
create a place \texttt{firing}$_t$ that will contains the ``lock token'' while simulating the firing of the parametrised transition, and a silent transition \texttt{done}$_t$ to release the lock,
then for all parameterized output arc to a place $p$, replace it by the places \texttt{tank1}$_{t,p}$, \texttt{tank2}$_{t,p}$ and the silent transitions \texttt{reload}$_{t,p}$, \texttt{fire}$_{t,p}$ as depicted.

This construction comes from \cite{David17}, to which we have added the uniqueness of the \texttt{lock} place for the whole network and its connection with all the transitions, even those not parameterized.
This does not fundamentally change the properties of the newly built network, in that it also provides a simulation, but it reduces the size of its state tree.

\begin{lemm}
  For all valuation $v$ on $\mathbb{P}$, $v(\PPNii)$ weakly simulates $v(\PPNi)$.
\end{lemm}

\begin{proof}
  First consider $v(\PPNi)$ and $v(\PPNi')$ where $\PPNi'$ is the network augmented by the \texttt{lock} place and its arcs from and to the non-parametrised transitions.
  The simulation is obvious here: it contains all the pair of markings $(\mar_1, \mar_2)$ such that $\mar_1 \in \Post^*_v(\mar_{0,1})$ and
  \[
    \mar_2(p) =
      \begin{cases}
        1 &\text{ if $p$ is \texttt{lock},} \\
        \mar_1(p) &\text{ otherwise.}
      \end{cases}
  \]

  Now consider $v(\PPNii)$ and focus on the parametrised transitions.
  Each time an arc from $t$ to $p$ parametrised by $a$ ($\matO_{\PPNi}(p)(t) = a$) is involved in a firing in $v(\PPNi)$, $v(a)$ tokens are created in $p$.
  Regarding $v(\PPNii)$, the sequence $(t, \mathtt{fire}_{t,p}, \mathtt{done}_t, \mathtt{reload}_{t,p})$, where $\mathtt{fire}_{t,p}$ and $\mathtt{reload}_{t,p}$ are repeated $a$ times, creates $v(a)$ tokens in $p$ and reset the sub-net constructed for the simulation\todo{rewrite with regular notation}. Note that the rest of the network is not affected. Thus, monotonicity ensures that we have a weak simulation.
\end{proof}

One can easily see that the weak simulation contains all the pair $(\mar_1, \mar_2)$ such that $\mar_1 \in \Post^*_v(\mar_{0,1})$ and
\[
  \mar_2(p') =
    \begin{cases}
      \mar_1(p') &\text{ if } p' \in P_1 \text{,}\\
      1 &\text{ if $p'$ is \texttt{lock},} \\
      v(a)\text{, with $a$ the parameter from $t$ to $p$} &\text{ if $p'$ is }\mathtt{tank1}_{t,p}\text{,} \\
      0 &\text{ otherwise.}
    \end{cases}
\]

Looking at the subnetwork in Figure~\ref{fig:posttppn-to-pppn},
one guesses that the simulation does not contain “many” other places.
Indeed, by unfolding the transition relation on the created subnet for $\matO_{\PPNi}(p)(t) = a$, one can observe that the reachable markings when $t$ is fired only once are of the form:
\[
  \mar_2(p') =
  \begin{cases}
    l   &\text{ if } p' \text{ is } \mathtt{lock}, \\
    f   &\text{ if } p' \text{ is } \mathtt{firing}_t, \\
    a_1 &\text{ if } p' \text{ is } \mathtt{tank1}_{t,p}, \\
    a_2 &\text{ if } p' \text{ is } \mathtt{tank2}_{t,p}, \\
    a_3 &\text{ if } p' \text{ is } p
  \end{cases}
  \text{\qquad with }
  \left\{
    \begin{aligned}
      l + f &= 1 \\
      a_1 + a_2 &= a \\
      a_3 &\leq a_1 \leq a
    \end{aligned}
  \right.
\]

Thus, for all reachable marking $\mar_2 \in \Post^*_{v(\PPNii)}(\mar_{0,2})$ of \PPNii there exists a reachable marking $\mar_1 \in \Post^*_{v(\PPNi)}(\mar_{0,1})$ of \PPNi that ``covers'' it for all the common places: $\forall p \in P_1, \mar_1(p) \geq \mar_2(p)$.
Actually, \PPNi also simulates \PPNii.
(\PPNi and \PPNii are said to be \emph{weakly co-similar}.)

\begin{lemm}
  For all valuation $v$ on $\mathbb{P}$, $v(\PPNi)$ weakly simulates $v(\PPNii)$.
\end{lemm}

\begin{proof}
  For all $\mar_{0,2} \fire[\val(\PPNii)]{t} \mar_{1,2}$, there exists $\mar_{1,1}$ such that $\mar_{0,1} \fire[v(\PPNi)]{t} \mar_{1,1}$.
  After firing this first transition, either the transition was a non-parametrized one and we can repeat the operation, or it was parametrized and the lock disables the observable transitions until $\mathtt{done}_t$ has been fired.
  In the latter case, any firable sequence ending with $\mathtt{done}_t$ is silent and produces a marking $\mar'_{1,2}$ covered by $\mar_{1,1}$.
  Thus, by monotonicity and thanks to the lock, we know that once $\mathtt{done}_t$ has been fired, all the transitions enabled in $\mar'_{1,2}$ in \PPNii are enabled in $\mar_{1,1}$ in \PPNi, except for some \texttt{reload} ones whose the effect is restricted to the \texttt{tank} places.
  This can therefore be repeated and provides us with the desired weak-simulation.
\end{proof}

\subsection{Karp and Miller algorithm for \Ecov on PostT-\ac{PPN}}

The adaptation of the Karp and Miller algorithm to solve the \Ecov problem on PostT-\acp{PPN} is the result of one key observation.
In a PostT-\ac{PPN}, a place may contains an arbitrary large number of tokens either because of the presence of a self-covering increasing sequence, as in a plain \ac{PN}, or because of an arbitrary large valuation.
In the latter case, the place is not necessary \emph{unbounded}, that is to say, once a valuation is given, the number of tokens the place may contains may be bounded, even if the bound is arbitrary large due to the arbitrary large values of the valuation.

The adaptation of the Karp and Miller algorithm is therefore mainly the addition of a way to distinguish between these two cases.
It is done by introducing a new value allowed in the markings, noted $*$ and such that $* \notin \mathbb{N}$, $* \neq \omega$, and $\forall c \in \mathbb{N}$, we have:
\begin{itemize}
  \item $c < * < \omega$,
  \item $* - c = *$,
  \item $* + c = *$,
  \item $\omega - * = \omega$, and
  \item $\omega + * = \omega$.
\end{itemize}

For our purpose, we add: \todo{or not?}
\begin{itemize}
  \item $* + * = *$, and
  \item $\omega + \omega = \omega$.
\end{itemize}

$*$ being defined, the propagation of the $*$ still have to be ensured in the cases where all the input places of a transition are marked by a $*$, even if the output of the transition is not a parameter.
This is done by adapting the acceleration function.
This new acceleration function, $\Acc$, distinguishes three cases.
Given a marking to accelerate $\mar$ with the set $S$ of markings as the base of the acceleration
the values of the different places of the accelerated marking are determined as follows:
\[
  \Acc(\mar, S)(p) =
  \begin{cases}
    \omega & \text{if } \exists \marp \in S : \marp \prec \mar \text{ and } \marp(p) < \mar(p)
    ...
  \end{cases}
\]
\begin{itemize}
  \item Either there exists $\marp \in S$ such that $\marp \fire{\sigma} \mar$, $\marp \prec \mar$, and for all place $p$ such that $\marp(p) \neq \omega$ we have $\Effect(\sigma)(p) \geq 0$.\\
    This case corresponds to the classic acceleration and
    if $\marp(p) < \mar(p)$
    we have:
    \[
      \Acc(\mar, S)(p) = \omega
    \]
  \item Or these first conditions does not hold but there exists a marking $\marp \in S$ such that $\marp \fire{\sigma} \mar$, $\marp \prec \mar$, and for all place $p$ such that $\marp(p) \notin \{\omega, *\}$ we have $\Effect(\sigma)(p) \geq 0$.\\
    This case handle the propagation of the $*$ mentioned above and
    if $\marp(p) < \mar(p)$
    we have:
    \[
      \Acc(\mar, S)(p) = *
    \]
  \item Or no one of the previous cases hold.
    In this case $\Acc(\mar, S)(p) = \mar(p)$.
\end{itemize}

Intuitively, the second case formalise the idea that one can remove some tokens from a place with $*$ tokens without being an issue for the existence of a valuation that allows to cover a given marking.

Keeping in mind that we are looking for the existence of a valuation, as large as it may be, that allows to cover a (set of) marking(s) of the \ac{PPN} \PPN, one can now perform the Karp and Miller algorithm, with the adapted acceleration function, on the plain \ac{PN} $v(\PPN)$ where $v$ is the $*$-valuation that maps every parameter to $*$.

\subsection{Karp and Miller algorithm for \Ucov on PreT-\ac{PPN}}

Here is a symmetrical situation.
The parameters are used to indicate the number of tokens required for transitions to fire, and we want to determine if a (set of) marking(s) is coverable for all the possible valuations of the parameters, as large as they may be.
Therefore, the adaptation of the Karp and Miller algorithm lies on considering that a transition with parametric input arcs is enabled if and only if the corresponding places are marked by $\omega$.
This ensure that the transition is regarded as enabled only if it may actually fire whatever the valuation.
The other direction of the implication holds too, that is to say that, if a transition has a parametric input arc whose the corresponding place is bounded, there exists a valuation that does not enable the transition.
Indeed, recall that all simultaneous unbounded places in a \ac{PN} appear marked by $\omega$ in at least one label of the Karp and Miller tree for this \ac{PN}.

% vim: set spell spelllang=en :
